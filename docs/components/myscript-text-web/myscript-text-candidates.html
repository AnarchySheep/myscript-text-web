<link rel="import" href="../polymer/polymer.html">

<dom-module id="myscript-text-candidates">
    <style>
        :host {
            box-sizing: border-box;
            display: flex;
            align-items: center;
            /*color: var(--myscript-text-candidates-color, #000000);*/
            min-height: 60px;
        }

        .text {
            color: var(--myscript-text-candidates-color, #1580CD);
            background-color: var(--myscript-text-candidates-background-color, #EDF0F2);
            padding: .5rem .75rem;
            margin: 0 .125rem;
            border-radius: 3px;
            cursor: pointer;
            flex: 0 0 auto;
        }

        .text[selected] {
            color: var(--myscript-text-candidates-selected-color, #FFFFFF);
            background-color: var(--myscript-text-candidates-selected-background-color, #1580CD);
        }

        .candidate[selected] * {
            color: inherit;
            background-color: inherit;
        }

        .char.predicted {
            color: var(--myscript-text-candidates-predicted-color, #73818C);
        }

        .char.completed {
            color: var(--myscript-text-candidates-completed-color, #1A9FFF);
        }
    </style>
    <template>
        <template is="dom-if" if="[[ rawresult.result ]]">
            <!--WARN: templates needs to be inline to avoid carriage return after span-->
            <template is="dom-repeat" id="textCandidateList" items="[[ rawresult.result.textSegmentResult.candidates ]]"
                      as="textCandidate"
                      index-as="textIndex">
                <span class$="text {{ _getCandidateFlags(candidate) }}"
                      selected$="[[ _isSelected(textIndex, rawresult.result.textSegmentResult.selectedCandidateIdx) ]]"
                      on-tap="_select">
                    <template is="dom-if" if="[[ !textCandidate.children ]]">
                            {{ textCandidate.label }}
                    </template>
                    <template is="dom-if" if="[[ textCandidate.children ]]"><!--WARN: templates needs to be inline to avoid carriage return after span-->
                        <template is="dom-repeat" id="wordCandidateList"
                                  items="[[ _getChildCandidates(textCandidate, rawresult, 'text') ]]"
                                  as="wordCandidate">
                            <span class$="word {{ _getCandidateFlags(wordCandidate) }}">
                                <template is="dom-if" if="[[ !wordCandidate.children ]]">
                                    {{ wordCandidate.label }}
                                </template>
                                <template is="dom-if" if="[[ wordCandidate.children ]]">
                                    <template is="dom-repeat" id="charCandidateList"
                                              items="[[ _getChildCandidates(wordCandidate, rawresult, 'word') ]]"
                                              as="charCandidate"><span
                                        class$="char {{ _getCandidateFlags(charCandidate) }}">{{ charCandidate.label }}</span></template>
                                </template>
                            </span>
                         </template>
                     </template>
                </span>
            </template>
        </template>
    </template>
</dom-module>

<script>
    Polymer({
                is: 'myscript-text-candidates',
                properties: {
                    rawresult: {
                        type: Object,
                        notify: true
                    }
                },
                /**
                 * Select a new candidate
                 * @param e
                 */
                _select: function (e) {
                    var rawresult = this.rawresult;
                    rawresult.result.textSegmentResult.selectedCandidateIdx = e.model.textIndex;
                    this.rawresult = {};
                    this.rawresult = rawresult;
                    var eventDetail = {
                        rawResult: rawresult,
                        exports: {
                            TEXT: rawresult.result.textSegmentResult.candidates[rawresult.result.textSegmentResult.selectedCandidateIdx].label
                        }
                    };
                    this.dispatchEvent(new CustomEvent('change', { detail: eventDetail}));
                },
                _isSelected: function (index, selectedIndex) {
                    return index === selectedIndex;
                },
                _getChildSegments: function (candidate, rawresult, type) {
                    var segments = [];

                    function addSegment(child, segment) {
                        if (segment.inkRanges === child.inkRanges) {
                            segment.selectedCandidateIdx = child.selectedCandidateIdx;
                            segments.push(segment);
                        }
                    }

                    if (candidate.children) {
                        candidate.children.forEach(function (child, index) {
                            if (type === 'text' &&
                                rawresult &&
                                rawresult.result &&
                                rawresult.result.wordSegments &&
                                rawresult.result.wordSegments.length > -1) {
                                rawresult.result.wordSegments.forEach(function (segment) {
                                    addSegment(child, segment);
                                });
                            } else if (type === 'word' &&
                                rawresult &&
                                rawresult.result &&
                                rawresult.result.charSegments &&
                                rawresult.result.charSegments.length > -1) {
                                if (!child.inkRanges) {
                                    var seg = {
                                        candidates: [{
                                            label: candidate.label.charAt(index),
                                            flags: candidate.flags
                                        }],
                                        selectedCandidateIdx: 0
                                    };
                                    segments.push(seg);
                                } else {
                                    rawresult.result.charSegments.forEach(function (segment) {
                                        addSegment(child, segment);
                                    });
                                }
                            }
                        });
                    }
                    return segments;
                },
                _getChildCandidates: function (candidate, rawresult, type) {
                    var candidates = [];
                    this._getChildSegments(candidate, rawresult, type)
                        .forEach(function (segment) {
                            candidates.push(segment.candidates[segment.selectedCandidateIdx]);
                        });
                    return candidates;
                },
                _getCandidateFlags: function (candidate) {
                    if (candidate && candidate.flags) {
                        return candidate.flags.join(' ').toLowerCase();
                    }
                    return '';
                }
            });
</script>
