<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../myscript-toolbar/myscript-toolbar.html">
<link rel="import" href="../myscript-result/myscript-result.html">
<link rel="import" href="../myscript-stroker/myscript-stroker.html">
<link rel="import" href="../myscript-renderer/myscript-renderer.html">
<link rel="import" href="../myscript-recognizer/myscript-recognizer.html">
<link rel="import" href="../myscript-canvas/myscript-canvas.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <myscript-text url="http://localhost:8888/api/v3.0/recognition/rest" applicationkey="ed45a5b4-946d-45c4-8234-fb840fb6416b" hmackey="a1789a80-8514-3d17-acd0-cc5d6674acea" type="Text"></myscript-text>

@element myscript-text
@blurb MyScript HTML5 text Element to help developers integrate handwriting recognition.
@status alpha
@homepage http://polymerlabs.github.io/myscript-text
-->
<polymer-element name="myscript-text" attributes="url applicationkey hmackey type" on-myscript-toolbar-delete="{{delete}}" on-myscript-toolbar-undo="{{undo}}" on-myscript-toolbar-redo="{{redo}}">
    <template>
        <link rel="stylesheet" href="./myscript-text.css">
        <core-scaffold>
            <div vertical layout>
                <div>
                    <myscript-result></myscript-result>
                </div>
                <div>
                    <myscript-toolbar delete="true" undo="true" redo="true" play="true" settings="true" info="true"></myscript-toolbar>
                    <myscript-stroker></myscript-stroker>
                    <myscript-renderer type="{{type}}"></myscript-renderer>
                    <myscript-recognizer type="{{type}}" url="{{url}}" applicationkey="{{applicationkey}}" hmackey="{{hmackey}}" ></myscript-recognizer>
                    <myscript-canvas on-myscript-canvas-down="{{down}}" on-myscript-canvas-track="{{track}}" on-myscript-canvas-up="{{up}}"></myscript-canvas>
                </div>
            </div>
        </core-scaffold>
    </template>
    <script>
        Polymer({
            result: '',
            toolbar: '',
            stroker: '',
            renderer: '',
            recognizer: '',
            canvas: '',
            rendererParameters: '',
            recognizerParameters: '',
            instanceId: '',
            inputUnit: '',
            inputUnits: [],
            delete: function(event){
                this.result.clear();
                this.stroker.clear();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.instanceId ='';
            },
            undo: function(event){
                this.stroker.undo();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.renderer.drawStrokes(this.stroker.getStrokes(), this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
            },
            redo: function(event){
                this.stroker.redo();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.renderer.drawStrokes(this.stroker.getStrokes(), this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
            },
            down: function(event){
                this.stroker.startStrokeWriting(event.detail.x, event.detail.y, event.detail.event.timeStamp);
                this.renderer.drawStart(event.detail.event, event.detail.x, event.detail.y);
            },
            track: function(event){
                this.stroker.continueStrokeWriting(event.detail.x, event.detail.y, event.detail.event.timeStamp);
                this.renderer.drawContinue(event.detail.event, event.detail.x, event.detail.y, this.canvas.shadowRoot.querySelector('canvas').getContext('2d'), this.rendererParameters);
            },
            up: function(event){
                this.stroker.endStrokeWriting();
                this.renderer.drawEnd(event.detail.event, event.detail.x, event.detail.y, this.canvas.shadowRoot.querySelector('canvas').getContext('2d'), this.rendererParameters);
                this.inputUnit.setComponents(this.stroker.getStrokes());
                this.inputUnits.push(this.inputUnit);
                this.recognizer.doSimpleRecognition(this.applicationkey, this.instanceId, this.inputUnits, this.hmackey, this.recognizerParameters).then(
                        function success (response) {
                            document.querySelector('myscript-text').shadowRoot.querySelector('myscript-recognizer').fire('recognitionSuccessEvent',{response:response});
                            document.querySelector('myscript-text').instanceId = response.instanceId;
                        },
                        function error (response) {
                            document.querySelector('myscript-text').shadowRoot.querySelector('myscript-recognizer').fire('recognitionErrorEvent',{response:response});
                        }
                );
            },
            ready: function() {

                this.result = this.shadowRoot.querySelector('myscript-result');
                this.toolbar = this.shadowRoot.querySelector('myscript-toolbar');
                this.stroker = this.shadowRoot.querySelector('myscript-stroker');
                this.renderer = this.shadowRoot.querySelector('myscript-renderer');
                this.recognizer = this.shadowRoot.querySelector('myscript-recognizer');
                this.canvas = this.shadowRoot.querySelector('myscript-canvas');

                this.rendererParameters = this.renderer.createRenderingParameter();
                this.recognizerParameters = this.recognizer.createTextParameter();

                this.recognizerParameters.setLanguage('en_US');
                this.recognizerParameters.setInputMode('CURSIVE');

                this.instanceId = '';
                this.inputUnit = new MyScript.TextInputUnit();
                this.inputUnits = [];
            }
        });
    </script>
</polymer-element>